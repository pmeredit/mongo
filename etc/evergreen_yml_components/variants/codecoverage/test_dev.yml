# Build variants in direct support of Code Coverage

buildvariants:
  # Variant to support Code Coverage on arm64
  - name: &AL2023-arm64-coverage AL2023-arm64-coverage
    display_name: "~ AL2023.3 Arm64 Code Coverage"
    run_on:
      - amazon2023.3-arm64-large
    cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
    stepback: false
    expansions:
      test_flags: --excludeWithAnyTags=resource_intensive,incompatible_with_gcov
      compile_flags: >-
        --allocator=system
        --gcov
        --opt=off
        --dbg=on
        --ssl
        MONGO_DISTMOD=amazon2023
        -j$(grep -c ^processor /proc/cpuinfo)
        --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
        --link-model=dynamic
      large_distro_name: amazon2023.3-arm64-large
      resmoke_jobs_factor: 0.5 # Avoid starting too many mongod's
      # Mixing --cache and --gcov doesn't work correctly yet. See SERVER-11084
      exec_timeout_secs: 32400 # 9 hour timeout
      timeout_secs: 18000 # 5 hour idle timeout
      use_scons_cache: false
      gcov_tool: /opt/mongodbtoolchain/v4/bin/gcov
      num_scons_link_jobs_available: 0.99
      compile_variant: *AL2023-arm64-coverage
    tasks: &AL2023-arm64-coverage-tasks
      - name: compile_and_package_serial_no_unittests_TG
        distros:
          - amazon2023.3-arm64-large
      - name: compile_test_parallel_unittest_stream_TG
        distros:
          - amazon2023.3-arm64-large
      - name: bazel_coverage

  # Variant to support Code Coverage on amd64/x86_64
  - name: &rhel-93-64-bit-coverage rhel-93-64-bit-coverage
    display_name: "~ RHEL 9.3 Code Coverage"
    run_on:
      - rhel93-medium
    cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
    stepback: false
    expansions:
      test_flags: --excludeWithAnyTags=resource_intensive,incompatible_with_gcov
      compile_flags: >-
        --allocator=system
        --gcov
        --opt=off
        --dbg=on
        --ssl
        MONGO_DISTMOD=rhel93
        -j$(grep -c ^processor /proc/cpuinfo)
        --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
        --link-model=dynamic
      large_distro_name: rhel93-medium
      resmoke_jobs_factor: 0.5 # Avoid starting too many mongod's
      # Mixing --cache and --gcov doesn't work correctly yet. See SERVER-11084
      exec_timeout_secs: 32400 # 9 hour timeout
      timeout_secs: 18000 # 5 hour idle timeout
      use_scons_cache: false
      gcov_tool: /opt/mongodbtoolchain/v4/bin/gcov
      num_scons_link_jobs_available: 0.99
      compile_variant: *rhel-93-64-bit-coverage
    tasks: &rhel-93-64-bit-coverage-tasks
      - name: compile_and_package_serial_no_unittests_TG
        distros:
          - rhel93-large
      - name: compile_test_parallel_unittest_stream_TG
        distros:
          - rhel93-large
      - name: bazel_coverage

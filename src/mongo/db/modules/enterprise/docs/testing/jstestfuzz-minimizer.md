# jstestfuzz Minimizer - for query and aggregation fuzzers

## Background
jstestfuzz's query and aggregation fuzzer generates a random set of documents,
indexes, and commands (i.e. queries or aggregations) to test differences in
result sets from commands between server versions, and with/without pipeline
optimization.

jstestfuzz generates several sets of random documents, which are run by
resmoke on the mongodb-mongo-master waterfall. The results between versions are
compared against known issues and if an unknown issue is found, a BF is
generated to allow an engineer to correct the issue or whitelist the difference.

The fuzzers generate 200 documents, 250 indexes, and 200 commands (either
queries or aggregation pipelines). Engineers have either tolerated working
with this large set of data, or have manually reduced this down to a much
smaller set. Regardless, significant time is consumed by this process.

The jstestfuzz minimizer seeks to eliminate wasted time by reducing the set
to the smallest number of documents, indexes and commands (dubbed the `minimized
set`) that can replicate a bug to allow an engineer to more quickly and easily
drill down to an issue.

## Operation
The jstestfuzz minimizer is integrated into generated tests and runs
automatically at the end of a jstestfuzz test if a failure is generated in an
aggregation or query fuzzer test that is not a timeseries diff test.

Once complete, a file `./minimizer-outputs.json` will be written to `$PWD`. This
file contains the `minimized set` of commands, documents, and indexes, and
additional data required to generate a new test. From
the jstestfuzz directory, invoke `npm run [fuzzer] -- -j ./path/to/minimizer-outputs.json`.
This will generate the minimized test file to `out/minimizer-outputs-minimizedtest.js`.

In almost all cases, a new test file is uploaded to Evergreen as
"Minimized jstestfuzz Test - Execution [n]" which contains the minimized
reproducer for that error. Rarely, this fails to occur because either 
1. an exception occurred during minimization, or 2. the process timed out in
Evergreen. In both cases, these issues should be reported to SDP.

To work around a timeout in Evergreen, you can run the minimizer
locally by running the original generated jstest in resmoke.py. See the task
log for the correct resmoke.py invocation.

## Method
The minimizer produces a minimized test:
1. When a query or aggregation command causes a failure (either when running
the command or when comparing the command's results), that failing command
is assumed to be the sole command required to replicate the bug.
2. Documents are minimized by removing documents one-at-a-time and attempting
to replicate the bug. If the bug is replicable without a document, it is removed
from the document set. This process continues until a set of all required
documents has been produced.
3. Indexes are minimized in the same fashion. Indexes minimization is performed
last because rebuilding an index after reducing the document set is faster.

At this point, minimization is complete. The `minimized set` is written to disk,
which can be fed back into the minimizer with the -j flag to generate a test
file that contains only the `minimized set`.

## Non-trivial, Irritating, Internal Details

### Command Percolation
As noted above in step 1, the failing command is assumed to be the sole command
responsible for the failure. This command is percolated upwards by wrapping
errors from the query and aggregation fuzzers in the QueryError and AggError
structures. These exceptions preserve the stack property of the exception they
are wrapping (i.e. the stack trace generated matches the stack trace of
the original exception).

### Error Sanitization
The errors generated by jstestfuzz were originally intended to be compared by
humans as opposed to by software. For example, the aggregation fuzzer can
generate an error with the text "Failed to find all results in ... for example"
which is followed by a human readable diff of the expected vs actual results. The
`exceptionWrapper` function removes the human readable portion of the error
to allow the minimizer to compare error messages. 

### Order of Operations
We perform minimization in the following order: command, documents, indexes.
The commands are immediately minimized to a single command because all
fuzzer errors are attributable to a single command. We percolate this error up
to immediately reduce the search space.

We then perform document minimization, because deleting/inserting a document
is a relatively quick operation, even with indexes, relative to rebuilding the
index.

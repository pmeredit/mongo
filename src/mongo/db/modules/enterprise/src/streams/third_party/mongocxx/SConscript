# -*- mode: python -*-

Import('env')

env = env.Clone()

env.InjectThirdParty(libraries=["bson", 'zstd', 'snappy'])

# Ignore these warnings in mongocxx and mongoc code.
env.Append(CCFLAGS=['-Wno-implicit-fallthrough'])
env.Append(CCFLAGS=['-Wno-sign-compare'])
# TODO(SERVER-77205): Review and Possibly Remove '-Wno-deprecated' After Mozjs Update
env.Append(CXXFLAGS=[] if env.TargetOSIs('windows') else [
    '-Wno-deprecated',
], )

platform_name = "linux_" + env["TARGET_ARCH"]
if env.ToolchainIs('clang'):
    # TODO(SERVER-76494): Remove this workaround once clang-tidy support exclusion of header paths
    env.Append(CCFLAGS=[
        '-isystem',
        env.Dir('$BUILD_DIR/mongo/db/modules/enterprise/src/streams/third_party/mongocxx/dist'
                ).srcnode().abspath,
        '-isystem',
        env.Dir(
            '$BUILD_DIR/mongo/db/modules/enterprise/src/streams/third_party/mongocxx/dist/mongoc').
        srcnode().abspath,
        '-isystem',
        env.Dir(
            '$BUILD_DIR/mongo/db/modules/enterprise/src/streams/third_party/mongocxx/dist/mongoc/common'
        ).srcnode().abspath,
        '-isystem',
        env.Dir(
            f'$BUILD_DIR/mongo/db/modules/enterprise/src/streams/third_party/mongocxx/dist/platform/{platform_name}'
        ).srcnode().abspath,
        '-isystem',
        env.Dir(
            f'$BUILD_DIR/mongo/db/modules/enterprise/src/streams/third_party/mongocxx/dist/platform/{platform_name}/mongoc'
        ).srcnode().abspath,
        '-isystem',
        env.Dir('$BUILD_DIR/third_party/libbson/dist/src/libbson/src/bson').srcnode().abspath,
    ])
    env.Append(CXXFLAGS=[
        '-isystem',
        env.Dir('$BUILD_DIR/mongo/db/modules/enterprise/src/streams/third_party/mongocxx/dist'
                ).srcnode().abspath,
        '-isystem',
        env.Dir(
            '$BUILD_DIR/mongo/db/modules/enterprise/src/streams/third_party/mongocxx/dist/mongoc').
        srcnode().abspath,
        '-isystem',
        env.Dir(
            '$BUILD_DIR/mongo/db/modules/enterprise/src/streams/third_party/mongocxx/dist/mongoc/common'
        ).srcnode().abspath,
        '-isystem',
        env.Dir(
            f'$BUILD_DIR/mongo/db/modules/enterprise/src/streams/third_party/mongocxx/dist/platform/{platform_name}'
        ).srcnode().abspath,
        '-isystem',
        env.Dir(
            f'$BUILD_DIR/mongo/db/modules/enterprise/src/streams/third_party/mongocxx/dist/platform/{platform_name}/mongoc'
        ).srcnode().abspath,
        '-isystem',
        env.Dir('$BUILD_DIR/third_party/libbson/dist/src/libbson/src/bson').srcnode().abspath,
    ])
else:
    env.Append(CPPPATH=[
        # Source file include path
        '$BUILD_DIR/mongo/db/modules/enterprise/src/streams/third_party/mongocxx/dist',
        '$BUILD_DIR/mongo/db/modules/enterprise/src/streams/third_party/mongocxx/dist/mongoc',
        '$BUILD_DIR/mongo/db/modules/enterprise/src/streams/third_party/mongocxx/dist/mongoc/common',
        # Platform specific source file include path
        # TODO https://jira.mongodb.org/browse/SERVER-74961: Support other platforms.
        f'$BUILD_DIR/mongo/db/modules/enterprise/src/streams/third_party/mongocxx/dist/platform/{platform_name}',
        f'$BUILD_DIR/mongo/db/modules/enterprise/src/streams/third_party/mongocxx/dist/platform/{platform_name}/mongoc',
        # To support #include <bson.h> in mongoc source
        '$BUILD_DIR/third_party/libbson/dist/src/libbson/src/bson',
    ])

# mongoc will complain unless MONGOC_COMPILATION is defined.
env.Append(CPPDEFINES=["MONGOC_COMPILATION"])
env.Library(
    target="mongoc",
    source=[
        'dist/mongoc/mongoc-aggregate.c',
        'dist/mongoc/mongoc-apm.c',
        'dist/mongoc/mongoc-array.c',
        'dist/mongoc/mongoc-async-cmd.c',
        'dist/mongoc/mongoc-async.c',
        'dist/mongoc/mongoc-buffer.c',
        'dist/mongoc/mongoc-bulk-operation.c',
        'dist/mongoc/mongoc-change-stream.c',
        'dist/mongoc/mongoc-client-pool.c',
        'dist/mongoc/mongoc-client-session.c',
        'dist/mongoc/mongoc-client-side-encryption.c',
        'dist/mongoc/mongoc-client.c',
        'dist/mongoc/mongoc-cluster-aws.c',
        'dist/mongoc/mongoc-cluster-cyrus.c',
        'dist/mongoc/mongoc-cluster-sasl.c',
        'dist/mongoc/mongoc-cluster-sspi.c',
        'dist/mongoc/mongoc-cluster.c',
        'dist/mongoc/mongoc-cmd.c',
        'dist/mongoc/mongoc-collection.c',
        'dist/mongoc/mongoc-compression.c',
        'dist/mongoc/mongoc-counters.c',
        'dist/mongoc/mongoc-crypt.c',
        'dist/mongoc/mongoc-crypto-cng.c',
        'dist/mongoc/mongoc-crypto-common-crypto.c',
        'dist/mongoc/mongoc-crypto-openssl.c',
        'dist/mongoc/mongoc-crypto.c',
        'dist/mongoc/mongoc-cursor-array.c',
        'dist/mongoc/mongoc-cursor-change-stream.c',
        'dist/mongoc/mongoc-cursor-cmd-deprecated.c',
        'dist/mongoc/mongoc-cursor-cmd.c',
        'dist/mongoc/mongoc-cursor-find-cmd.c',
        'dist/mongoc/mongoc-cursor-find-opquery.c',
        'dist/mongoc/mongoc-cursor-find.c',
        'dist/mongoc/mongoc-cursor-legacy.c',
        'dist/mongoc/mongoc-cursor.c',
        'dist/mongoc/mongoc-cyrus.c',
        'dist/mongoc/mongoc-database.c',
        'dist/mongoc/mongoc-error.c',
        'dist/mongoc/mongoc-find-and-modify.c',
        'dist/mongoc/mongoc-generation-map.c',
        'dist/mongoc/mongoc-gridfs-bucket-file.c',
        'dist/mongoc/mongoc-gridfs-bucket.c',
        'dist/mongoc/mongoc-gridfs-file-list.c',
        'dist/mongoc/mongoc-gridfs-file-page.c',
        'dist/mongoc/mongoc-gridfs-file.c',
        'dist/mongoc/mongoc-gridfs.c',
        'dist/mongoc/mongoc-handshake.c',
        'dist/mongoc/mongoc-host-list.c',
        'dist/mongoc/mongoc-http.c',
        'dist/mongoc/mongoc-index.c',
        'dist/mongoc/mongoc-init.c',
        'dist/mongoc/mongoc-interrupt.c',
        'dist/mongoc/mongoc-libressl.c',
        'dist/mongoc/mongoc-linux-distro-scanner.c',
        'dist/mongoc/mongoc-list.c',
        'dist/mongoc/mongoc-log.c',
        'dist/mongoc/mongoc-matcher-op.c',
        'dist/mongoc/mongoc-matcher.c',
        'dist/mongoc/mongoc-memcmp.c',
        'dist/mongoc/mongoc-ocsp-cache.c',
        'dist/mongoc/mongoc-openssl.c',
        'dist/mongoc/mongoc-optional.c',
        'dist/mongoc/mongoc-opts-helpers.c',
        'dist/mongoc/mongoc-opts.c',
        'dist/mongoc/mongoc-queue.c',
        'dist/mongoc/mongoc-rand-cng.c',
        'dist/mongoc/mongoc-rand-common-crypto.c',
        'dist/mongoc/mongoc-rand-openssl.c',
        'dist/mongoc/mongoc-read-concern.c',
        'dist/mongoc/mongoc-read-prefs.c',
        'dist/mongoc/mongoc-rpc.c',
        'dist/mongoc/mongoc-sasl.c',
        'dist/mongoc/mongoc-scram.c',
        'dist/mongoc/mongoc-secure-channel.c',
        'dist/mongoc/mongoc-secure-transport.c',
        'dist/mongoc/mongoc-server-api.c',
        'dist/mongoc/mongoc-server-description.c',
        'dist/mongoc/mongoc-server-monitor.c',
        'dist/mongoc/mongoc-server-stream.c',
        'dist/mongoc/mongoc-set.c',
        'dist/mongoc/mongoc-shared.c',
        'dist/mongoc/mongoc-socket.c',
        'dist/mongoc/mongoc-ssl.c',
        'dist/mongoc/mongoc-sspi.c',
        'dist/mongoc/mongoc-stream-buffered.c',
        'dist/mongoc/mongoc-stream-file.c',
        'dist/mongoc/mongoc-stream-gridfs-download.c',
        'dist/mongoc/mongoc-stream-gridfs-upload.c',
        'dist/mongoc/mongoc-stream-gridfs.c',
        'dist/mongoc/mongoc-stream-socket.c',
        'dist/mongoc/mongoc-stream-tls-libressl.c',
        'dist/mongoc/mongoc-stream-tls-openssl-bio.c',
        'dist/mongoc/mongoc-stream-tls-openssl.c',
        'dist/mongoc/mongoc-stream-tls-secure-channel.c',
        'dist/mongoc/mongoc-stream-tls-secure-transport.c',
        'dist/mongoc/mongoc-stream-tls.c',
        'dist/mongoc/mongoc-stream.c',
        'dist/mongoc/mongoc-timeout.c',
        'dist/mongoc/mongoc-topology-background-monitoring.c',
        'dist/mongoc/mongoc-topology-description-apm.c',
        'dist/mongoc/mongoc-topology-description.c',
        'dist/mongoc/mongoc-topology-scanner.c',
        'dist/mongoc/mongoc-topology.c',
        'dist/mongoc/mongoc-ts-pool.c',
        'dist/mongoc/mongoc-uri.c',
        'dist/mongoc/mongoc-util.c',
        'dist/mongoc/mongoc-version-functions.c',
        'dist/mongoc/mongoc-write-command-legacy.c',
        'dist/mongoc/mongoc-write-command.c',
        'dist/mongoc/mongoc-write-concern.c',
    ],
    LIBDEPS_PRIVATE=[
        '$BUILD_DIR/third_party/shim_icu',
        '$BUILD_DIR/third_party/shim_libbson',
        '$BUILD_DIR/third_party/shim_libmongocrypt',
        '$BUILD_DIR/third_party/shim_snappy',
        '$BUILD_DIR/third_party/shim_zstd',
    ],
    SYSLIBDEPS=[
        'sasl2',
    ],
)

env.Library(
    target="bsoncxx",
    source=[
        'dist/bsoncxx/array/element.cpp',
        'dist/bsoncxx/array/value.cpp',
        'dist/bsoncxx/array/view.cpp',
        'dist/bsoncxx/builder/core.cpp',
        'dist/bsoncxx/decimal128.cpp',
        'dist/bsoncxx/document/element.cpp',
        'dist/bsoncxx/document/value.cpp',
        'dist/bsoncxx/document/view.cpp',
        'dist/bsoncxx/exception/error_code.cpp',
        'dist/bsoncxx/json.cpp',
        'dist/bsoncxx/oid.cpp',
        'dist/bsoncxx/private/itoa.cpp',
        'dist/bsoncxx/string/view_or_value.cpp',
        'dist/bsoncxx/types.cpp',
        'dist/bsoncxx/types/bson_value/value.cpp',
        'dist/bsoncxx/types/bson_value/view.cpp',
        'dist/bsoncxx/validate.cpp',
    ],
    LIBDEPS_PRIVATE=[
        '$BUILD_DIR/mongo/util/boost_assert_shim',
        '$BUILD_DIR/third_party/shim_libbson',
    ],
)

env.Library(
    target="mongocxx",
    source=[
        'dist/mongocxx/bulk_write.cpp',
        'dist/mongocxx/change_stream.cpp',
        'dist/mongocxx/client.cpp',
        'dist/mongocxx/client_encryption.cpp',
        'dist/mongocxx/client_session.cpp',
        'dist/mongocxx/collection.cpp',
        'dist/mongocxx/cursor.cpp',
        'dist/mongocxx/database.cpp',
        'dist/mongocxx/events/command_failed_event.cpp',
        'dist/mongocxx/events/command_started_event.cpp',
        'dist/mongocxx/events/command_succeeded_event.cpp',
        'dist/mongocxx/events/heartbeat_failed_event.cpp',
        'dist/mongocxx/events/heartbeat_started_event.cpp',
        'dist/mongocxx/events/heartbeat_succeeded_event.cpp',
        'dist/mongocxx/events/server_changed_event.cpp',
        'dist/mongocxx/events/server_closed_event.cpp',
        'dist/mongocxx/events/server_description.cpp',
        'dist/mongocxx/events/server_opening_event.cpp',
        'dist/mongocxx/events/topology_changed_event.cpp',
        'dist/mongocxx/events/topology_closed_event.cpp',
        'dist/mongocxx/events/topology_description.cpp',
        'dist/mongocxx/events/topology_opening_event.cpp',
        'dist/mongocxx/exception/error_code.cpp',
        'dist/mongocxx/exception/operation_exception.cpp',
        'dist/mongocxx/exception/server_error_code.cpp',
        'dist/mongocxx/gridfs/bucket.cpp',
        'dist/mongocxx/gridfs/downloader.cpp',
        'dist/mongocxx/gridfs/uploader.cpp',
        'dist/mongocxx/options/gridfs/bucket.cpp',
        'dist/mongocxx/options/gridfs/upload.cpp',
        'dist/mongocxx/result/gridfs/upload.cpp',
        'dist/mongocxx/hint.cpp',
        'dist/mongocxx/index_model.cpp',
        'dist/mongocxx/index_view.cpp',
        'dist/mongocxx/instance.cpp',
        'dist/mongocxx/logger.cpp',
        'dist/mongocxx/model/delete_many.cpp',
        'dist/mongocxx/model/delete_one.cpp',
        'dist/mongocxx/model/insert_one.cpp',
        'dist/mongocxx/model/replace_one.cpp',
        'dist/mongocxx/model/update_many.cpp',
        'dist/mongocxx/model/update_one.cpp',
        'dist/mongocxx/model/write.cpp',
        'dist/mongocxx/options/aggregate.cpp',
        'dist/mongocxx/options/apm.cpp',
        'dist/mongocxx/options/auto_encryption.cpp',
        'dist/mongocxx/options/bulk_write.cpp',
        'dist/mongocxx/options/change_stream.cpp',
        'dist/mongocxx/options/client.cpp',
        'dist/mongocxx/options/client_encryption.cpp',
        'dist/mongocxx/options/client_session.cpp',
        'dist/mongocxx/options/count.cpp',
        'dist/mongocxx/options/create_collection.cpp',
        'dist/mongocxx/options/data_key.cpp',
        'dist/mongocxx/options/delete.cpp',
        'dist/mongocxx/options/distinct.cpp',
        'dist/mongocxx/options/encrypt.cpp',
        'dist/mongocxx/options/estimated_document_count.cpp',
        'dist/mongocxx/options/find.cpp',
        'dist/mongocxx/options/find_one_and_delete.cpp',
        'dist/mongocxx/options/find_one_and_replace.cpp',
        'dist/mongocxx/options/find_one_and_update.cpp',
        'dist/mongocxx/options/index.cpp',
        'dist/mongocxx/options/index_view.cpp',
        'dist/mongocxx/options/insert.cpp',
        'dist/mongocxx/options/pool.cpp',
        'dist/mongocxx/options/replace.cpp',
        'dist/mongocxx/options/server_api.cpp',
        'dist/mongocxx/options/tls.cpp',
        'dist/mongocxx/options/transaction.cpp',
        'dist/mongocxx/options/update.cpp',
        'dist/mongocxx/pipeline.cpp',
        'dist/mongocxx/pool.cpp',
        'dist/mongocxx/private/conversions.cpp',
        'dist/mongocxx/private/libbson.cpp',
        'dist/mongocxx/private/libmongoc.cpp',
        'dist/mongocxx/private/numeric_casting.cpp',
        'dist/mongocxx/read_concern.cpp',
        'dist/mongocxx/read_preference.cpp',
        'dist/mongocxx/result/bulk_write.cpp',
        'dist/mongocxx/result/delete.cpp',
        'dist/mongocxx/result/insert_many.cpp',
        'dist/mongocxx/result/insert_one.cpp',
        'dist/mongocxx/result/replace_one.cpp',
        'dist/mongocxx/result/update.cpp',
        'dist/mongocxx/uri.cpp',
        'dist/mongocxx/validation_criteria.cpp',
        'dist/mongocxx/write_concern.cpp',
    ],
    LIBDEPS=[
        'bsoncxx',
        'mongoc',
    ],
    LIBDEPS_PRIVATE=[
        '$BUILD_DIR/mongo/util/boost_assert_shim',
        '$BUILD_DIR/third_party/shim_libbson',
    ],
)

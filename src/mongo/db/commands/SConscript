# -*- mode: python -*-

Import("env")
Import("has_option")
Import("get_option")

env = env.Clone()

env.SConscript(
    must_exist=1,
    dirs=[
        "query_cmd",
    ],
    exports=[
        "env",
    ],
)

# Commands that are present in both mongod and embedded
env.Library(
    target="standalone",
    source=[
        "create_command.cpp",
        "create_indexes_cmd.cpp",
        "dbcommands.cpp",
        "drop_indexes_cmd.cpp",
        "fle2_get_count_info_command.cpp",
        "http_client.cpp",
        "http_client_gen.cpp",
        "kill_op.cpp",
        "killoperations_cmd.cpp",
        "list_collections.cpp",
        "list_databases.cpp",
        "list_databases_for_all_tenants.cpp",
        "list_indexes.cpp",
        "lock_info.cpp",
        "query_cmd/aggregation_execution_state.cpp",
        "query_cmd/analyze_cmd.cpp",
        "query_cmd/count_cmd.cpp",
        "query_cmd/current_op.cpp",
        "query_cmd/distinct.cpp",
        "query_cmd/explain_cmd.cpp",
        "query_cmd/find_and_modify.cpp",
        "query_cmd/find_cmd.cpp",
        "query_cmd/getmore_cmd.cpp",
        "query_cmd/index_filter_commands.cpp",
        "query_cmd/killcursors_cmd.cpp",
        "query_cmd/pipeline_command.cpp",
        "query_cmd/plan_cache_clear_command.cpp",
        "query_cmd/plan_cache_commands.cpp",
        "query_cmd/run_aggregate.cpp",
        "query_cmd/write_commands.cpp",
        "rename_collection_cmd.cpp",
        "sleep_command.cpp",
        "shuffle_list_command_results.cpp",
        "validate.cpp",
        "validate_db_metadata_cmd.cpp",
        "whats_my_sni_command.cpp",
    ],
    LIBDEPS_PRIVATE=[
        "$BUILD_DIR/mongo/base",
        "$BUILD_DIR/mongo/crypto/encrypted_field_config",
        "$BUILD_DIR/mongo/crypto/fle_crypto",
        "$BUILD_DIR/mongo/db/api_parameters",
        "$BUILD_DIR/mongo/db/catalog/catalog_helpers",
        "$BUILD_DIR/mongo/db/catalog/collection_query_info",
        "$BUILD_DIR/mongo/db/catalog/collection_validation",
        "$BUILD_DIR/mongo/db/catalog/database_holder",
        "$BUILD_DIR/mongo/db/catalog/index_key_validate",
        "$BUILD_DIR/mongo/db/catalog/multi_index_block",
        "$BUILD_DIR/mongo/db/change_stream_change_collection_manager",
        "$BUILD_DIR/mongo/db/change_stream_pre_images_collection_manager",
        "$BUILD_DIR/mongo/db/change_stream_serverless_helpers",
        "$BUILD_DIR/mongo/db/coll_mod_command_idl",
        "$BUILD_DIR/mongo/db/command_can_run_here",
        "$BUILD_DIR/mongo/db/commands",
        "$BUILD_DIR/mongo/db/concurrency/exception_util",
        "$BUILD_DIR/mongo/db/concurrency/lock_manager",
        "$BUILD_DIR/mongo/db/curop_failpoint_helpers",
        "$BUILD_DIR/mongo/db/dbcommands_idl",
        "$BUILD_DIR/mongo/db/exec/sbe/query_sbe_abt",
        "$BUILD_DIR/mongo/db/fle_crud",
        "$BUILD_DIR/mongo/db/fle_crud_mongod",
        "$BUILD_DIR/mongo/db/index_builds_coordinator_interface",
        "$BUILD_DIR/mongo/db/index_commands_idl",
        "$BUILD_DIR/mongo/db/multitenancy",
        "$BUILD_DIR/mongo/db/pipeline/aggregation_request_helper",
        "$BUILD_DIR/mongo/db/pipeline/docs_needed_bounds_visitor",
        "$BUILD_DIR/mongo/db/pipeline/process_interface/mongo_process_interface",
        "$BUILD_DIR/mongo/db/pipeline/process_interface/mongod_process_interfaces",
        "$BUILD_DIR/mongo/db/query/client_cursor/client_cursor",
        "$BUILD_DIR/mongo/db/query/client_cursor/cursor_response_idl",
        "$BUILD_DIR/mongo/db/query/command_request_response",
        "$BUILD_DIR/mongo/db/query/query_settings/manager",
        "$BUILD_DIR/mongo/db/query/query_shape/query_shape",
        "$BUILD_DIR/mongo/db/query/query_stats/query_stats",
        "$BUILD_DIR/mongo/db/query/search/search_index_process_shard",
        "$BUILD_DIR/mongo/db/query/stats/stats",
        "$BUILD_DIR/mongo/db/query/stats/stats_histograms",
        "$BUILD_DIR/mongo/db/query/write_ops/write_ops",
        "$BUILD_DIR/mongo/db/query/write_ops/write_ops_exec",
        "$BUILD_DIR/mongo/db/query_exec",
        "$BUILD_DIR/mongo/db/repl/replica_set_messages",
        "$BUILD_DIR/mongo/db/repl/tenant_migration_access_blocker",
        "$BUILD_DIR/mongo/db/rw_concern_d",
        "$BUILD_DIR/mongo/db/s/query_analysis_writer",
        "$BUILD_DIR/mongo/db/server_base",
        "$BUILD_DIR/mongo/db/server_feature_flags",
        "$BUILD_DIR/mongo/db/session/session_catalog_mongod",
        "$BUILD_DIR/mongo/db/stats/counters",
        "$BUILD_DIR/mongo/db/stats/server_read_concern_write_concern_metrics",
        "$BUILD_DIR/mongo/db/stats/top",
        "$BUILD_DIR/mongo/db/storage/storage_engine_common",
        "$BUILD_DIR/mongo/db/storage/storage_options",
        "$BUILD_DIR/mongo/db/storage/two_phase_index_build_knobs_idl",
        "$BUILD_DIR/mongo/db/timeseries/catalog_helper",
        "$BUILD_DIR/mongo/db/timeseries/timeseries_collmod",
        "$BUILD_DIR/mongo/db/timeseries/timeseries_conversion_util",
        "$BUILD_DIR/mongo/db/timeseries/timeseries_options",
        "$BUILD_DIR/mongo/db/timeseries/timeseries_write_util",
        "$BUILD_DIR/mongo/db/transaction/transaction",
        "$BUILD_DIR/mongo/db/transaction/transaction_operations",
        "$BUILD_DIR/mongo/db/views/view_catalog_helpers",
        "$BUILD_DIR/mongo/executor/async_request_executor",
        "$BUILD_DIR/mongo/rpc/rewrite_state_change_errors",
        "$BUILD_DIR/mongo/s/query_analysis_sampler",
        "$BUILD_DIR/mongo/s/resource_yielders",
        "$BUILD_DIR/mongo/s/sharding_router_api",
        "$BUILD_DIR/mongo/util/log_and_backoff",
        "$BUILD_DIR/mongo/util/net/http_client",
        "buildinfo_common",
        "core",
        "create_command",
        "fsync_locked",
        "kill_common",
        "list_collections_filter",
        "list_databases_command",
        "list_databases_for_all_tenants_command",
        "lock_info_command",
        "query_cmd/bulk_write_command",
        "query_cmd/current_op_common",
        "query_cmd/search_index_commands",
        "rename_collection_idl",
        "test_commands_enabled",
        "validate_db_metadata_command",
    ],
)

# Commands that should only be present in mongod
env.Library(
    target="mongod",
    source=[
        "apply_ops_cmd.cpp",
        "auto_compact.cpp",
        "collection_to_capped.cpp",
        "compact.cpp",
        "compact_gen.cpp",
        "dbhash.cpp",
        "filemd5_cmd.cpp",
        "fle2_cleanup_cmd.cpp",
        "fle2_compact_cmd.cpp",
        "get_cluster_parameter_command.cpp",
        "internal_rename_if_options_and_indexes_match_cmd.cpp",
        "internal_rename_if_options_and_indexes_match_gen.cpp",
        "internal_transactions_test_command_d.cpp",
        "oplog_application_checks.cpp",
        "oplog_note.cpp",
        "profile_cmd.cpp",
        "query_cmd/change_stream_state_command.cpp",
        "query_cmd/map_reduce_command.cpp",
        "read_write_concern_defaults_server_status.cpp",
        "resize_oplog.cpp",
        "resize_oplog_gen.cpp",
        "rwc_defaults_commands.cpp",
        "set_cluster_parameter_command.cpp",
        "set_feature_compatibility_version_command.cpp",
        "set_index_commit_quorum_command.cpp",
        "set_user_write_block_mode_command.cpp",
        "shutdown_d.cpp",
        "snapshot_management.cpp",
        "tenant_migration_donor_cmds.cpp",
        "tenant_migration_recipient_cmds.cpp",
        "top_command.cpp",
        "txn_cmds.cpp",
        "user_management_commands.cpp",
        "vote_abort_index_build_command.cpp",
        "vote_commit_index_build_command.cpp",
        "vote_index_build_gen.cpp",
    ],
    LIBDEPS_PRIVATE=[
        "$BUILD_DIR/mongo/client/clientdriver_minimal",
        "$BUILD_DIR/mongo/crypto/fle_crypto",
        "$BUILD_DIR/mongo/db/auth/address_restriction",
        "$BUILD_DIR/mongo/db/auth/auth",
        "$BUILD_DIR/mongo/db/auth/auth_options",
        "$BUILD_DIR/mongo/db/auth/auth_umc",
        "$BUILD_DIR/mongo/db/auth/authprivilege",
        "$BUILD_DIR/mongo/db/auth/builtin_roles",
        "$BUILD_DIR/mongo/db/auth/sasl_options",
        "$BUILD_DIR/mongo/db/auth/user",
        "$BUILD_DIR/mongo/db/auth/user_document_parser",
        "$BUILD_DIR/mongo/db/catalog/catalog_control",
        "$BUILD_DIR/mongo/db/catalog/catalog_helpers",
        "$BUILD_DIR/mongo/db/catalog/catalog_impl",
        "$BUILD_DIR/mongo/db/catalog/database_holder",
        "$BUILD_DIR/mongo/db/catalog/index_key_validate",
        "$BUILD_DIR/mongo/db/change_stream_change_collection_manager",
        "$BUILD_DIR/mongo/db/change_stream_options_manager",
        "$BUILD_DIR/mongo/db/change_stream_pre_images_collection_manager",
        "$BUILD_DIR/mongo/db/change_stream_state",
        "$BUILD_DIR/mongo/db/cluster_transaction_api",
        "$BUILD_DIR/mongo/db/coll_mod_command_idl",
        "$BUILD_DIR/mongo/db/commands",
        "$BUILD_DIR/mongo/db/curop_failpoint_helpers",
        "$BUILD_DIR/mongo/db/dbhelpers",
        "$BUILD_DIR/mongo/db/exec/stagedebug_cmd",
        "$BUILD_DIR/mongo/db/fle_crud_mongod",
        "$BUILD_DIR/mongo/db/index_builds_coordinator_interface",
        "$BUILD_DIR/mongo/db/index_commands_idl",
        "$BUILD_DIR/mongo/db/modules/enterprise/src/live_import/commands/export_collection_command"
        if "live_import" in env.get("MONGO_ENTERPRISE_FEATURES", [])
        else "",
        "$BUILD_DIR/mongo/db/modules/enterprise/src/live_import/commands/import_collection_command"
        if "live_import" in env.get("MONGO_ENTERPRISE_FEATURES", [])
        else "",
        "$BUILD_DIR/mongo/db/modules/enterprise/src/live_import/commands/vote_commit_import_collection_command"
        if "live_import" in env.get("MONGO_ENTERPRISE_FEATURES", [])
        else "",
        "$BUILD_DIR/mongo/db/multitenancy",
        "$BUILD_DIR/mongo/db/pipeline/pipeline",
        "$BUILD_DIR/mongo/db/pipeline/process_interface/mongo_process_interface",
        "$BUILD_DIR/mongo/db/profile_collection",
        "$BUILD_DIR/mongo/db/repl/dbcheck",
        "$BUILD_DIR/mongo/db/repl/oplog",
        "$BUILD_DIR/mongo/db/repl/repl_coordinator_interface",
        "$BUILD_DIR/mongo/db/repl/repl_server_parameters",
        "$BUILD_DIR/mongo/db/repl/replica_set_messages",
        "$BUILD_DIR/mongo/db/repl/tenant_migration_donor_service",
        "$BUILD_DIR/mongo/db/repl/tenant_migration_recipient_service",
        "$BUILD_DIR/mongo/db/rw_concern_d",
        "$BUILD_DIR/mongo/db/s/sharding_catalog",
        "$BUILD_DIR/mongo/db/s/sharding_catalog_manager",
        "$BUILD_DIR/mongo/db/s/sharding_commands_d",
        "$BUILD_DIR/mongo/db/s/sharding_runtime_d",
        "$BUILD_DIR/mongo/db/s/transaction_coordinator",
        "$BUILD_DIR/mongo/db/s/user_writes_recoverable_critical_section",
        "$BUILD_DIR/mongo/db/server_base",
        "$BUILD_DIR/mongo/db/set_change_stream_state_coordinator",
        "$BUILD_DIR/mongo/db/stats/top",
        "$BUILD_DIR/mongo/db/timeseries/timeseries_conversion_util",
        "$BUILD_DIR/mongo/db/transaction/transaction_api",
        "$BUILD_DIR/mongo/executor/inline_executor",
        "$BUILD_DIR/mongo/util/net/ssl_manager",
        "$BUILD_DIR/mongo/util/progress_meter",
        "cluster_server_parameter_commands_invocation",
        "core",
        "create_command",
        "dbcheck_command",
        "kill_common",
        "mongod_fcv",
        "mongod_fsync",
        "profile_common",
        "query_cmd/map_reduce_agg",
        "rwc_defaults_commands",
        "servers",
        "set_cluster_parameter_impl",
        "set_feature_compatibility_version_idl",
        "set_index_commit_quorum_idl",
        "set_user_write_block_mode_idl",
        "shutdown_idl",
        "standalone",
        "tenant_migration_cmds_request",
        "test_commands",
        "test_commands_enabled",
        "txn_cmd_request",
        "umc_commands_idl",
    ],
)

env.CppUnitTest(
    target="command_mirroring_test",
    source=[
        "command_mirroring_test.cpp",
    ],
    LIBDEPS=[
        "$BUILD_DIR/mongo/base",
        "$BUILD_DIR/mongo/db/auth/authmocks",
        "$BUILD_DIR/mongo/db/auth/authorization_manager_global",
        "$BUILD_DIR/mongo/db/commands",
        "$BUILD_DIR/mongo/db/service_context_non_d",
        "$BUILD_DIR/mongo/unittest/unittest",
        "standalone",
    ],
)

env.CppUnitTest(
    target="async_command_execution_test",
    source=[
        "async_command_execution_test.cpp",
    ],
    LIBDEPS=[
        "$BUILD_DIR/mongo/base",
        "$BUILD_DIR/mongo/db/auth/authmocks",
        "$BUILD_DIR/mongo/db/auth/authorization_manager_global",
        "$BUILD_DIR/mongo/db/commands",
        "$BUILD_DIR/mongo/db/commands/standalone",
        "$BUILD_DIR/mongo/db/service_context_non_d",
        "$BUILD_DIR/mongo/db/service_context_test_fixture",
        "$BUILD_DIR/mongo/util/version_impl",
    ],
)

env.CppUnitTest(
    target="db_commands_test",
    source=[
        "create_command_test.cpp",
        "create_indexes_test.cpp",
        "dbcheck_command_test.cpp",
        "fle_compact_test.cpp",
        "list_collections_filter_test.cpp",
        "parse_log_component_settings_test.cpp",
        "query_cmd/explain_test.cpp",
        "query_cmd/external_data_source_commands_test.cpp",
        "query_cmd/index_filter_commands_test.cpp",
        "query_cmd/mr_test.cpp" if get_option("js-engine") != "none" else [],
        "query_cmd/plan_cache_commands_test.cpp",
        "server_status_command_test.cpp",
        "server_status_metric_test.cpp",
        "set_cluster_parameter_invocation_test.cpp",
    ],
    LIBDEPS=[
        "$BUILD_DIR/mongo/crypto/aead_encryption",
        "$BUILD_DIR/mongo/crypto/encrypted_field_config",
        "$BUILD_DIR/mongo/crypto/fle_crypto",
        "$BUILD_DIR/mongo/db/auth/authmocks",
        "$BUILD_DIR/mongo/db/catalog/catalog_test_fixture",
        "$BUILD_DIR/mongo/db/catalog/health_log",
        "$BUILD_DIR/mongo/db/collection_crud/collection_crud",
        "$BUILD_DIR/mongo/db/concurrency/exception_util",
        "$BUILD_DIR/mongo/db/dbdirectclient",
        "$BUILD_DIR/mongo/db/fle_crud",
        "$BUILD_DIR/mongo/db/fle_mocks",
        "$BUILD_DIR/mongo/db/multitenancy",
        "$BUILD_DIR/mongo/db/op_observer/op_observer",
        "$BUILD_DIR/mongo/db/query/query_planner",
        "$BUILD_DIR/mongo/db/query/query_test_service_context",
        "$BUILD_DIR/mongo/db/query_exec",
        "$BUILD_DIR/mongo/db/repl/dbcheck_test_fixture",
        "$BUILD_DIR/mongo/db/repl/replmocks",
        "$BUILD_DIR/mongo/db/repl/storage_interface_impl",
        "$BUILD_DIR/mongo/db/service_context_d_test_fixture",
        "$BUILD_DIR/mongo/db/shard_role",
        "$BUILD_DIR/mongo/db/storage/record_store_base",
        "$BUILD_DIR/mongo/idl/idl_parser",
        "$BUILD_DIR/mongo/shell/kms_idl",
        "$BUILD_DIR/mongo/util/version_impl",
        "cluster_server_parameter_commands_invocation",
        "core",
        "create_command",
        "dbcheck_command",
        "list_collections_filter",
        "mongod",
        "server_status_core",
        "servers",
        "standalone",
    ],
)

# -*- mode: python -*-

Import("env", "get_option")

env = env.Clone()

env.Library(
    target="auth_impl_internal",
    source=[
        "authorization_manager_impl.cpp",
        "authorization_manager_impl_parameters_gen.cpp",
        "authorization_session_impl.cpp",
        "authz_manager_external_state.cpp",
        "authz_session_external_state.cpp",
    ],
    LIBDEPS=[
        "$BUILD_DIR/mongo/base/secure_allocator",
        "$BUILD_DIR/mongo/bson/util/bson_extract",
        "$BUILD_DIR/mongo/db/common",
        "$BUILD_DIR/mongo/db/global_settings",
        "$BUILD_DIR/mongo/db/query/query_stats/query_stats",
        "$BUILD_DIR/mongo/db/server_base",
        "$BUILD_DIR/mongo/util/concurrency/thread_pool",
        "$BUILD_DIR/mongo/util/icu",
        "$BUILD_DIR/mongo/util/net/ssl_manager",
        "$BUILD_DIR/mongo/util/net/ssl_types",
        "address_restriction",
        "auth",
        "authentication_session",
        "authorization_manager_global",
        "authprivilege",
        "builtin_roles",
        "sasl_options",
        "user",
        "user_acquisition_stats",
        "user_document_parser",
        "user_request_x509" if get_option("ssl") == "on" else [],
    ],
    LIBDEPS_PRIVATE=[
        "$BUILD_DIR/mongo/db/api_parameters",
        "$BUILD_DIR/mongo/db/audit",  # audit:logLogout in AuthZSession.
        "$BUILD_DIR/mongo/db/stats/counters",
        "$BUILD_DIR/mongo/util/caching",
        "$BUILD_DIR/mongo/util/concurrency/spin_lock",
        "auth_umc",
    ],
)

env.Library(
    target="auth_impl_internal_local",
    source=[
        "authz_manager_external_state_local.cpp",
    ],
    LIBDEPS=[
        "auth_impl_internal",
    ],
    LIBDEPS_PRIVATE=[
        "$BUILD_DIR/mongo/db/multitenancy",
        "$BUILD_DIR/mongo/db/shard_role",
        "$BUILD_DIR/mongo/db/storage/storage_options",
    ],
)

env.Library(
    target="user_cache_invalidator",
    source=[
        "user_cache_invalidator_job.cpp",
        "user_cache_invalidator_job_parameters_gen.cpp",
    ],
    LIBDEPS=[
        "auth",
        "authorization_manager_global",
    ],
    LIBDEPS_PRIVATE=[
        "$BUILD_DIR/mongo/db/server_base",
        "$BUILD_DIR/mongo/s/grid",
        "auth_impl_internal_local",
    ],
)

env.Library(
    target="authserver",
    source=[
        "authorization_manager_factory_impl.cpp",
        "authz_manager_external_state_d.cpp",
        "authz_manager_external_state_s.cpp",
        "authz_session_external_state_server_common.cpp",
        "authz_session_external_state_d.cpp",
        "authz_session_external_state_s.cpp",
        "authorization_client_handle_router.cpp",
        "authorization_client_handle_shard.cpp",
        "enable_localhost_auth_bypass_parameter_gen.cpp",
    ],
    LIBDEPS=[
        "auth",
        "authorization_manager_global",
        "sasl_commands",
        "saslauth",
        "user_cache_invalidator",
    ],
    LIBDEPS_PRIVATE=[
        "$BUILD_DIR/mongo/db/commands/authentication_commands",
        "$BUILD_DIR/mongo/db/commands/umc_commands_idl",
        "$BUILD_DIR/mongo/db/dbdirectclient",
        "$BUILD_DIR/mongo/db/dbhelpers",
        "$BUILD_DIR/mongo/db/repl/repl_coordinator_interface",
        "$BUILD_DIR/mongo/db/server_base",
        "$BUILD_DIR/mongo/s/grid",
        "auth_impl_internal_local",
    ],
)

env.Library(
    target="auth_op_observer",
    source=[
        "auth_op_observer.cpp",
    ],
    LIBDEPS_PRIVATE=[
        "$BUILD_DIR/mongo/base",
        "$BUILD_DIR/mongo/db/audit",
        "$BUILD_DIR/mongo/db/catalog/collection_options",
        "$BUILD_DIR/mongo/db/index/index_access_method",
        "$BUILD_DIR/mongo/db/op_observer/op_observer",
        "$BUILD_DIR/mongo/db/op_observer/op_observer_util",
        "$BUILD_DIR/mongo/db/repl/oplog_entry",
        "auth",
    ],
)

env.Library(
    target="auth_checks",
    source=[
        "authorization_checks.cpp",
    ],
    LIBDEPS=[
        "$BUILD_DIR/mongo/db/catalog/document_validation",
        "$BUILD_DIR/mongo/db/common",
        "$BUILD_DIR/mongo/db/pipeline/lite_parsed_document_source",
        "$BUILD_DIR/mongo/db/update/update_driver",
        "auth",
        "authprivilege",
        "builtin_roles",
        "user",
        "user_document_parser",
    ],
    LIBDEPS_PRIVATE=[
        "$BUILD_DIR/mongo/db/audit",
        "$BUILD_DIR/mongo/db/server_base",
    ],
)

env.Library(
    target="sasl_commands",
    source=[
        "sasl_commands.cpp",
        "sasl_commands_gen.cpp",
        "sasl_payload.cpp",
    ],
    LIBDEPS_PRIVATE=[
        "$BUILD_DIR/mongo/client/native_sasl_client",
        "$BUILD_DIR/mongo/db/commands",
        "$BUILD_DIR/mongo/db/commands/test_commands_enabled",
        "auth",
        "auth_impl_internal",
        "authentication_session",
        "authorization_manager_global",
        "saslauth",
    ],
)

env.Library(
    target="authmocks",
    source=[
        "authorization_manager_factory_mock.cpp",
        "authz_manager_external_state_mock.cpp",
        "authz_session_external_state_mock.cpp",
    ],
    LIBDEPS=[
        "$BUILD_DIR/mongo/db/query_expressions",
        "$BUILD_DIR/mongo/db/service_context",
        "$BUILD_DIR/mongo/db/update/update_driver",
        "auth",
        "auth_impl_internal",
        "auth_impl_internal_local",
        "authserver",
        "sasl_options",
        "sasl_options_init",
    ],
)

env.Library(
    target="authorization_session_test_fixture",
    source=[
        "authorization_session_for_test.cpp",
        "authorization_session_test_fixture.cpp",
    ],
    LIBDEPS=[
        "$BUILD_DIR/mongo/db/service_context_d_test_fixture",
        "$BUILD_DIR/mongo/transport/transport_layer_mock",
        "auth",
        "auth_impl_internal",
        "authmocks",
    ],
)

env.CppUnitTest(
    target="db_auth_test",
    source=[
        "action_set_test.cpp",
        "address_restriction_test.cpp",
        "auth_identifier_test.cpp",
        "authorization_contract_test.cpp",
        "auth_op_observer_test.cpp",
        "authentication_session_test.cpp",
        "authorization_manager_test.cpp",
        "authorization_session_test.cpp",
        "builtin_roles_test.cpp",
        "oauth_discovery_factory_test.cpp",
        "privilege_parser_test.cpp",
        "resolve_role_option_test.cpp",
        "resource_pattern_search_list_test.cpp",
        "restriction_test.cpp",
        "sasl_authentication_session_test.cpp",
        "sasl_mechanism_registry_test.cpp",
        "sasl_scram_test.cpp",
        "sasl_x509_test.cpp" if get_option("ssl") == "on" else [],
        "security_key_test.cpp",
        "user_acquisition_stats_test.cpp",
        "user_document_parser_test.cpp",
        "validated_tenancy_scope_test.cpp",
    ],
    LIBDEPS=[
        "$BUILD_DIR/mongo/base",
        "$BUILD_DIR/mongo/client/native_sasl_client",
        "$BUILD_DIR/mongo/db/common",
        "$BUILD_DIR/mongo/db/concurrency/exception_util",
        "$BUILD_DIR/mongo/db/op_observer/op_observer_util",
        "$BUILD_DIR/mongo/db/pipeline/pipeline",
        "$BUILD_DIR/mongo/db/repl/oplog",
        "$BUILD_DIR/mongo/db/repl/oplog_interface_local",
        "$BUILD_DIR/mongo/db/repl/replmocks",
        "$BUILD_DIR/mongo/transport/transport_layer_common",
        "$BUILD_DIR/mongo/util/net/mock_http_client",
        "$BUILD_DIR/mongo/util/net/network",
        "address_restriction",
        "auth_op_observer",
        "authentication_session",
        "authorization_session_test_fixture",
        "cluster_auth_mode",
        "sasl_mechanism_protocol",
        "saslauth",
        "security_file",
        "security_key",
        "security_token_auth",
        "user",
        "user_request_x509" if get_option("ssl") == "on" else [],
    ],
)
